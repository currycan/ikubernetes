---
# deploy zabbix agent
- hosts: test
  sudo: yes
  sudo_user: root
  tasks:
  - name: create zabbix  user
    user: "name=zabbix shell=/sbin/nologin password=zabbix"
  - name:  mkdir for zabbix agent
    file: path={{ item }}  owner=zabbix group=zabbix state=directory
    with_items:
    - /etc/zabbix/
    - /usr/local/zabbix/
    - /usr/local/zabbix/bin/
    - /usr/local/zabbix/sbin/
    - /usr/local/zabbix/conf/
    - /usr/local/zabbix/conf/zabbix_agentd/
  - name: copy files for zabbix
    copy: src={{ item.src }} dest={{item.dest}} owner=zabbix
    with_items:
    - { src: '/opt/sg_deploy/zabbix/bin/zabbix_get', dest: '/usr/local/zabbix/bin/zabbix_get' }
    - { src: '/opt/sg_deploy/zabbix/bin/zabbix_sender', dest: '/usr/local/zabbix/bin/zabbix_sender' }
    - { src: '/opt/sg_deploy/zabbix/sbin/zabbix_agentd', dest: '/usr/local/zabbix/sbin/zabbix_agentd' }
    - { src: '/opt/sg_deploy/zabbix/conf/zabbix_agentd.conf', dest: '/usr/local/zabbix/conf/zabbix_agentd.conf' }
    - { src: '/opt/sg_deploy/zabbix/conf/zabbix_agentd.conf', dest: '/usr/local/etc/zabbix_agentd.conf' }
    - { src: '/opt/sg_deploy/zabbix/conf/zabbix_agentd.conf', dest: '/etc/zabbix/zabbix_agentd.conf' }
    - { src: '/opt/sg_deploy/zabbix/conf/zabbix_agentd/pm2-zabbix.conf', dest: '/usr/local/zabbix/conf/zabbix_agentd/pm2-zabbix.conf' }
  - name:  action zabbix_agentd  
    file: path=/usr/local/zabbix/sbin/zabbix_agentd  owner=zabbix group=zabbix mode=777
  - name: change /usr/local/zabbix/conf/config hostname
    shell: hostname=`cat /etc/hostname`;sed -i "s/Hostname=*/Hostname=${hostname}/g" /usr/local/zabbix/conf/zabbix_agentd.conf
  - name: change /usr/local/etc/config hostname
    shell: hostname=`cat /etc/hostname`;sed -i "s/Hostname=*/Hostname=${hostname}/g" /usr/local/etc/zabbix_agentd.conf
  - name: change /etc/config hostname
    shell: hostname=`cat /etc/hostname`;sed -i "s/Hostname=*/Hostname=${hostname}/g" /etc/zabbix/zabbix_agentd.conf
